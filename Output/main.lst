C251 COMPILER V5.60.0,  main                                                               14/03/22  14:48:16  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE main
OBJECT MODULE PLACED IN .\Output\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C251\BIN\C251.EXE Code\main.c XSMALL INTR2 WARNINGLEVEL(3) BROWSE INCDIR(.\Code;.\Lib\li
                    -braries;.\Lib\seekfree_libraries;.\Lib\seekfree_peripheral;.\User) DEFINE(USE_8701E) DEBUG PRINT(.\Output\main.lst) OBJE
                    -CT(.\Output\main.obj) 

stmt  level    source

    1          /********************************************************************************************************
             -*************
    2           * COPYRIGHT NOTICE
    3           * Copyright (c) 2020,逐飞科技
    4           * All rights reserved.
    5           * 技术讨论QQ群：一群：179029047(已满)  二群：244861897(已满)  三群：824575535
    6           *
    7           * 以下所有内容版权均属逐飞科技所有，未经允许不得用于商业用途，
    8           * 欢迎各位使用并传播本程序，修改内容时必须保留逐飞科技的版权声明。
    9           *
   10           * @file                main
   11           * @company                     成都逐飞科技有限公司
   12           * @author              逐飞科技(QQ790875685)
   13           * @version             查看doc内version文件 版本说明
   14           * @Software            MDK FOR C251 V5.60
   15           * @Target core         STC16F40K128
   16           * @Taobao              https://seekfree.taobao.com/
   17           * @date                2020-12-18
   18           ********************************************************************************************************
             -************/
   19          
   20          #include "misc.h"
   21          #include "key.h"
   22          #include "buzz.h"
   23          #include "encoder.h"
   24          #include "servo.h"
   25          #include "motor.h"
   26          #include "indNavi.h"
   27          
   28          //编码器数据
   29          int16 encoder_data[2];
   30          //电感数据
   31          uint8 ind_data[indNum];
   32          //电机占空比
   33          int16 motor_duty[2];
   34          //舵机占空比
   35          uint16 servo_duty;
   36          
   37          void main()
   38          {
   39   1          //系统启动
   40   1          system_init();
   41   1          // setup
   42   1          lcd_showstr(0, 0, "Project Hikari");
   43   1          lcd_showstr(0, 1, "Batt:");
   44   1          lcd_showstr(0, 2, "Hall:");
   45   1          lcd_showstr(0, 3, "Key:");
   46   1          lcd_showstr(0, 4, "Enc:");
   47   1          lcd_showstr(0, 5, "Mtr:");
   48   1          lcd_showstr(0, 6, "SPD:");
   49   1          lcd_showstr(0, 7, "CNT:");
   50   1          lcd_showstr(0, 8, "IndC:");
   51   1      #if (defined(IND_EXT_MidSide) || defined(IND_EXT_MidRear))
                   lcd_showstr(0, 9, "IndX:");
               #endif
   54   1          while (1)
   55   1          {
C251 COMPILER V5.60.0,  main                                                               14/03/22  14:48:16  PAGE 2   

   56   2              // 核心轮询功能
   57   2              system_loop();
   58   2              // 处理5ms电机中断
   59   2              if (drvFlag)
   60   2              {
   61   3                  drvFUNC();
   62   3                  // 数据上屏
   63   3                  lcd_showint32(40, 4, encoder_data[0], 4);
   64   3                  lcd_showint32(80, 4, encoder_data[1], 4);
   65   3                  lcd_showint32(48, 8, indFilteredData[0], 2);
   66   3                  lcd_showint32(72, 8, indFilteredData[1], 2);
   67   3                  lcd_showint32(96, 8, indFilteredData[2], 2);
   68   3      #ifdef IND_EXT_MidSide
                           lcd_showint32(48, 9, indFilteredData[3], 2);
                           lcd_showint32(72, 9, indFilteredData[4], 2);
               #endif
   72   3      #ifdef IND_EXT_MidRear
                           lcd_showint32(96, 9, indFilteredData[5], 2);
               #endif
   75   3                  // 清除电机中断标记
   76   3                  drvFlag = !drvFlag;
   77   3              }
   78   2              //刷新霍尔传感
   79   2              lcd_showstr(40, 2, (Hall ? "N" : "D"));
   80   2          }
   81   1      }
   82          //驱动控制
   83          void drvFUNC(void)
   84          {
   85   1          // 同步编码器
   86   1          encoder_data[0] = getEncoder0Data();
   87   1          encoder_data[1] = -getEncoder1Data();
   88   1          // 同步电感
   89   1          getIndInfo(ind_data);
   90   1          // 计算
   91   1          
   92   1          // 同步舵机
   93   1          servoDirectCtrl(&servo_duty);
   94   1          // 同步电机
   95   1          motor0DirectCtrl(motor_duty[0]);
   96   1          motor1DirectCtrl(motor_duty[1]);
   97   1      }
   98          //按键处理
   99          void keyProg(void)
  100          {
  101   1          //按键0
  102   1          switch (keyState[0])
  103   1          {
  104   2          //短按
  105   2          case S1:
  106   2              beepShort();
  107   2              printf("S0\n");
  108   2              lcd_showstr(40, 3, "S0");
  109   2              keyState[0] = S0;
  110   2              break;
  111   2          //长按
  112   2          case S3:
  113   2              beepShort();
  114   2              printf("L1\n");
  115   2              lcd_showstr(40, 3, "L0");
  116   2              keyState[0] = S0;
  117   2              break;
  118   2          default:
  119   2              break;
  120   2          }
  121   1          //按键2
C251 COMPILER V5.60.0,  main                                                               14/03/22  14:48:16  PAGE 3   

  122   1          switch (keyState[1])
  123   1          {
  124   2          //短按
  125   2          case S1:
  126   2              beepShort();
  127   2              printf("S1\n");
  128   2              lcd_showstr(40, 3, "S1");
  129   2              keyState[1] = S0;
  130   2              break;
  131   2          //长按
  132   2          case S3:
  133   2              beepShort();
  134   2              printf("L1\n");
  135   2              lcd_showstr(40, 3, "L1");
  136   2              keyState[1] = S0;
  137   2              break;
  138   2          default:
  139   2              break;
  140   2          }
  141   1          //按键3
  142   1          switch (keyState[2])
  143   1          {
  144   2          //短按
  145   2          case S1:
  146   2              beepShort();
  147   2              printf("S2\n");
  148   2              lcd_showstr(40, 3, "S2");
  149   2              keyState[2] = S0;
  150   2              break;
  151   2          //长按
  152   2          case S3:
  153   2              beepShort();
  154   2              printf("L2\n");
  155   2              lcd_showstr(40, 3, "L2");
  156   2              keyState[2] = S0;
  157   2              break;
  158   2          default:
  159   2              break;
  160   2          }
  161   1          //按键4
  162   1          switch (keyState[3])
  163   1          {
  164   2          //短按
  165   2          case S1:
  166   2              beepShort();
  167   2              printf("S3\n");
  168   2              lcd_showstr(40, 3, "S3");
  169   2              keyState[3] = S0;
  170   2              break;
  171   2          //长按
  172   2          case S3:
  173   2              beepShort();
  174   2              printf("L3\n");
  175   2              lcd_showstr(40, 3, "L3");
  176   2              keyState[3] = S0;
  177   2              break;
  178   2          default:
  179   2              break;
  180   2          }
  181   1      }
  182          //拨码开关处理
  183          void swProg(void)
  184          {
  185   1          //拨码1
  186   1          //高
  187   1          if (SW1)
C251 COMPILER V5.60.0,  main                                                               14/03/22  14:48:16  PAGE 4   

  188   1          {
  189   2          }
  190   1          //低
  191   1          if (!SW1)
  192   1          {
  193   2          }
  194   1          //拨码2
  195   1          //高
  196   1          if (SW2)
  197   1          {
  198   2          }
  199   1          //低
  200   1          if (!SW2)
  201   1          {
  202   2          }
  203   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       696     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =        13     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =       114     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
