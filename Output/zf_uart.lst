C251 COMPILER V5.60.0,  zf_uart                                                            14/03/22  14:44:39  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE zf_uart
OBJECT MODULE PLACED IN .\Output\zf_uart.obj
COMPILER INVOKED BY: C:\Keil_v5\C251\BIN\C251.EXE Lib\seekfree_libraries\zf_uart.c XSMALL INTR2 WARNINGLEVEL(3) BROWSE I
                    -NCDIR(.\Code;.\Lib\libraries;.\Lib\seekfree_libraries;.\Lib\seekfree_peripheral;.\User) DEFINE(USE_8701E) DEBUG PRINT(.\
                    -Output\zf_uart.lst) OBJECT(.\Output\zf_uart.obj) 

stmt  level    source

    1          /********************************************************************************************************
             -*************
    2           * COPYRIGHT NOTICE
    3           * Copyright (c) 2020,é€é£žç§‘æŠ€
    4           * All rights reserved.
    5           * æŠ€æœ¯è®¨è®ºQQç¾¤ï¼šä¸€ç¾¤ï¼š179029047(å·²æ»¡)  äºŒç¾¤ï¼š244861897(å·²æ»¡)  ä¸‰ç¾¤ï¼š824575535
    6           *
    7           * ä»¥ä¸‹æ‰€æœ‰å†…å®¹ç‰ˆæƒå‡å±žé€é£žç§‘æŠ€æ‰€æœ‰ï¼Œæœªç»å…è®¸ä¸å¾—ç”¨äºŽå•†ä¸šç”¨é€”ï¼Œ
    8           * æ¬¢è¿Žå„ä½ä½¿ç”¨å¹¶ä¼ æ’­æœ¬ç¨‹åºï¼Œä¿®æ”¹å†…å®¹æ—¶å¿…é¡»ä¿ç•™é€é£žç§‘æŠ€çš„ç‰ˆæƒå£°æ˜Žã€‚
    9           *
   10           * @file                uart
   11           * @company                     æˆéƒ½é€é£žç§‘æŠ€æœ‰é™å…¬å¸
   12           * @author              é€é£žç§‘æŠ€(QQ790875685)
   13           * @version             æŸ¥çœ‹docå†…versionæ–‡ä»¶ ç‰ˆæœ¬è¯´æ˜Ž
   14           * @Software            MDK FOR C251 V5.60
   15           * @Target core         STC16F40K128
   16           * @Taobao              https://seekfree.taobao.com/
   17           * @date                2020-4-14
   18           ********************************************************************************************************
             -************/
   19          
   20          #include "zf_uart.h"
   21          #include "board.h"
   22             
   23          
   24          
   25          uint8 busy[5];                           //æŽ¥æ”¶å¿™æ ‡å¿—ä½
   26          
   27          uint8 uart1_tx_buff[UART1_TX_BUFFER_SIZE];      //å‘é€ç¼“å†²
   28          uint8 uart1_rx_buff[UART1_RX_BUFFER_SIZE];      //æŽ¥æ”¶ç¼“å†²
   29          
   30          
   31          //-------------------------------------------------------------------------------------------------------
             -------------
   32          //  @brief      ä¸²å£åˆå§‹åŒ–
   33          //  @param      uart_n          ä¸²å£æ¨¡å—å·(USART_1,USART_2,USART_3,USART_4)
   34          //  @param      uart_rx_pin     ä¸²å£æ³¢ç‰¹çŽ‡
   35          //  @param      uart_tx_pin     ä¸²å£æŽ¥æ”¶å‘é€å¼•è„š
   36          //  @param      baud                    ä¸²å£æŽ¥æ”¶å‘é€å¼•è„š
   37          //  @param      tim_n                   ä½¿ç”¨tim_nä½œä¸ºä¸²å£æ³¢ç‰¹çŽ‡å‘ç”Ÿå™¨(TIM1-TIM4)
   38          //  @return     NULL            
   39          //  Sample usage:               uart_init(UART_1, UART1_RX_P30, UART1_TX_P31, 115200, TIM_2);        //åˆ
             -å§‹åŒ–ä¸²å£1 æ³¢ç‰¹çŽ‡115200 å‘é€å¼•è„šä½¿ç”¨P31 æŽ¥æ”¶å¼•è„šä½¿ç”¨P30 ,ä½¿ç”¨å®šæ—¶å™¨2ä½œä¸ºæ³¢ç‰¹çŽ‡å‘ç”Ÿå™¨
   40          //  @note                       ä¸²å£1ä½¿ç”¨ å®šæ—¶å™¨1æˆ–è€…å®šæ—¶å™¨2 ä½œä¸ºæ³¢ç‰¹çŽ‡å‘ç”Ÿå™¨ã€‚
   41          //                                                              ä¸²å£2ä½¿ç”¨ å®šæ—¶å™¨2                         ä½œä¸ºæ³¢ç‰¹çŽ‡å‘ç”Ÿå™¨ã€‚
   42          //                                                              ä¸²å£3ä½¿ç”¨ å®šæ—¶å™¨3æˆ–è€…å®šæ—¶å™¨2 ä½œä¸ºæ³¢ç‰¹çŽ‡å‘ç”Ÿå™¨ã€‚
   43          //                                                              ä¸²å£4ä½¿ç”¨ å®šæ—¶å™¨4æˆ–è€…å®šæ—¶å™¨2 ä½œä¸ºæ³¢ç‰¹çŽ‡å‘ç”Ÿå™¨ã€‚
   44          //                              STC8Hä»…æœ‰ å®šæ—¶å™¨0-å®šæ—¶å™¨4ï¼Œè¿™5ä¸ªå®šæ—¶å™¨ã€‚
   45          //                                                              ç¼–ç å™¨é‡‡é›†æ•°æ®ä¹Ÿéœ€è¦å®šæ—¶å™¨ä½œä¸ºå¤–éƒ¨è®¡æ•°ã€‚
   46          //                                                              å¦‚æžœä¸åŒçš„ä¸²å£ï¼Œä½¿ç”¨åŒä¸€ä¸ªå®šæ—¶å™¨ï¼Œä¸²å£çš„æ³¢ç‰¹çŽ‡ä»¥æœ€åŽä¸€ä¸ªåˆå§‹åŒ–ä¸
             -ºå‡†
   47          //-------------------------------------------------------------------------------------------------------
             -------------
   48          void uart_init(UARTN_enum uart_n, UARTPIN_enum uart_rx_pin, UARTPIN_enum uart_tx_pin, uint32 baud, TIMN_e
             -num tim_n)
   49          {
   50   1          uint16 brt;
C251 COMPILER V5.60.0,  zf_uart                                                            14/03/22  14:44:39  PAGE 2   

   51   1      
   52   1              brt = (uint16)(65536 - (sys_clk/baud/4));
   53   1      
   54   1      
   55   1              switch(uart_n)
   56   1              {
   57   2                      case UART_1:
   58   2                      {
   59   3                              if(TIM_1 == tim_n)
   60   3                              {
   61   4                                      SCON |= 0x50;
   62   4                                      TMOD |= 0x00;
   63   4                                      TL1 = brt;
   64   4                                      TH1 = brt >> 8;
   65   4                                      AUXR |= 0x40;
   66   4                                      TR1 = 1;
   67   4                                      busy[1] = 0;
   68   4                              }
   69   3                              else if(TIM_2 == tim_n)
   70   3                              {
   71   4                                      SCON |= 0x50;
   72   4                                      T2L = brt;
   73   4                                      T2H = brt >> 8;
   74   4                                      AUXR |= 0x15;
   75   4                              }
   76   3                              P_SW1 &= ~(0x03<<6);
   77   3                              if((UART1_RX_P30 == uart_rx_pin) && (UART1_TX_P31 == uart_tx_pin))
   78   3                              {
   79   4                                      P_SW1 |= 0x00;
   80   4                              }
   81   3                              else if((UART1_RX_P36 == uart_rx_pin) && (UART1_TX_P37 == uart_tx_pin))
   82   3                              {
   83   4                                      P_SW1 |= 0x40;
   84   4                              }
   85   3                              else if((UART1_RX_P16 == uart_rx_pin) && (UART1_TX_P17 == uart_tx_pin))
   86   3                              {
   87   4                                      P_SW1 |= 0x80;
   88   4                              }
   89   3                              else if((UART1_RX_P43 == uart_rx_pin) && (UART1_TX_P44 == uart_tx_pin))
   90   3                              {
   91   4                                      P_SW1 |= 0xc0;
   92   4                              }
   93   3                              busy[1] = 0;
   94   3                              ES = 1;
   95   3                              break;
   96   3                      }
   97   2                      
   98   2                      case UART_2:
   99   2                      {
  100   3                              if(TIM_2 == tim_n)
  101   3                              {
  102   4                                      S2CON |= 0x10;
  103   4                                      T2L = brt;
  104   4                                      T2H = brt >> 8;
  105   4                                      AUXR |= 0x14;
  106   4                              }
  107   3                              
  108   3                              P_SW2 &= ~(0x01<<0);
  109   3                              if((UART2_RX_P10 == uart_rx_pin) && (UART2_TX_P11 == uart_tx_pin))
  110   3                              {
  111   4                                      P_SW2 |= 0x00;
  112   4                              }
  113   3                              else if((UART2_RX_P46 == uart_rx_pin) && (UART2_TX_P47 == uart_tx_pin))
  114   3                              {
  115   4                                      P_SW2 |= 0x01;
  116   4                              }
C251 COMPILER V5.60.0,  zf_uart                                                            14/03/22  14:44:39  PAGE 3   

  117   3                              
  118   3                              IE2 |= 0x01 << 0;       //å…è®¸ä¸²è¡Œå£2ä¸­æ–­
  119   3                              busy[2] = 0;
  120   3                              break;
  121   3                      }
  122   2                      
  123   2                      case UART_3:
  124   2                      {
  125   3                              if(TIM_2 == tim_n)
  126   3                              {
  127   4                                      S3CON |= 0x10;
  128   4                                      T2L = brt;
  129   4                                      T2H = brt >> 8;
  130   4                                      AUXR |= 0x14;
  131   4                              }
  132   3                              else if(TIM_3 == tim_n)
  133   3                              {
  134   4                                      S3CON |= 0x50;
  135   4                                      T3L = brt;
  136   4                                      T3H = brt >> 8;
  137   4                                      T4T3M |= 0x0a;
  138   4                              }
  139   3                              
  140   3                              P_SW2 &= ~(0x01<<1);
  141   3                              if((UART3_RX_P00 == uart_rx_pin) && (UART3_TX_P01 == uart_tx_pin))
  142   3                              {
  143   4                                      P_SW2 |= 0x00;
  144   4                              }
  145   3                              else if((UART3_RX_P50 == uart_rx_pin) && (UART3_TX_P51 == uart_tx_pin))
  146   3                              {
  147   4                                      P_SW2 |= 0x02;
  148   4                              }
  149   3                              
  150   3                              IE2 |= 0x01<<3; //å…è®¸ä¸²è¡Œå£3ä¸­æ–­
  151   3                              busy[3] = 0;
  152   3                              break;
  153   3                      }
  154   2                      
  155   2                      case UART_4:
  156   2                      {
  157   3                              if(TIM_2 == tim_n)
  158   3                              {
  159   4                                      S4CON |= 0x10;
  160   4                                      T2L = brt;
  161   4                                      T2H = brt >> 8;
  162   4                                      AUXR |= 0x14;
  163   4                              }
  164   3                              else if(TIM_4 == tim_n)
  165   3                              {
  166   4                                      S4CON |= 0x50;
  167   4                                      T4L = brt;
  168   4                                      T4H = brt >> 8;
  169   4                                      T4T3M |= 0xa0;
  170   4                              }
  171   3      
  172   3                              P_SW2 &= ~(0x01<<2);
  173   3                              if((UART4_RX_P02 == uart_rx_pin) && (UART4_TX_P03 == uart_tx_pin))
  174   3                              {
  175   4                                      P_SW2 |= 0x00;
  176   4                              }
  177   3                              else if((UART4_RX_P52 == uart_rx_pin) && (UART4_TX_P53 == uart_tx_pin))
  178   3                              {
  179   4                                      P5M0 = 0x00;
  180   4                                      P5M1 = 0x01<<2;//P5.2 éœ€è¦è®¾ç½®ä¸ºé«˜é˜»
  181   4                                      P_SW2 |= 0x04;
  182   4                              }
C251 COMPILER V5.60.0,  zf_uart                                                            14/03/22  14:44:39  PAGE 4   

  183   3                              IE2 |= 0x01<<4; //å…è®¸ä¸²è¡Œå£4ä¸­æ–­
  184   3                              busy[4] = 0;
  185   3                              break;
  186   3                      }
  187   2                      
  188   2              }
  189   1      
  190   1      }
  191          
  192          //-------------------------------------------------------------------------------------------------------
             -------------
  193          //  @brief      ä¸²å£å­—èŠ‚è¾“å‡º
  194          //  @param      uart_n          ä¸²å£æ¨¡å—å·(USART_1,USART_2,USART_3,USART_4)
  195          //  @param      dat             éœ€è¦å‘é€çš„å­—èŠ‚
  196          //  @return     void        
  197          //  Sample usage:               uart_putchar(UART_1,0xA5);       // ä¸²å£1å‘é€0xA5
  198          //-------------------------------------------------------------------------------------------------------
             -------------
  199          void uart_putchar(UARTN_enum uart_n,uint8 dat)
  200          {
  201   1              switch(uart_n)
  202   1              {
  203   2                      case UART_1:
  204   2                              while (busy[1]);
  205   2                              busy[1] = 1;
  206   2                              SBUF = dat;
  207   2                          break;
  208   2                      case UART_2:
  209   2                              while (busy[2]);
  210   2                              busy[2] = 1;
  211   2                              S2BUF = dat;
  212   2                          break;
  213   2                      case UART_3:
  214   2                              while (busy[3]);
  215   2                              busy[3] = 1;
  216   2                              S3BUF = dat;
  217   2                          break;
  218   2                      case UART_4:
  219   2                              while (busy[4]);
  220   2                              busy[4] = 1;
  221   2                              S4BUF = dat;
  222   2                          break;
  223   2              }
  224   1      }
  225          
  226          
  227          //-------------------------------------------------------------------------------------------------------
             -------------
  228          //  @brief      ä¸²å£å‘é€æ•°ç»„
  229          //  @param      uart_n          ä¸²å£æ¨¡å—å·(USART_1,USART_2,USART_3,USART_4)
  230          //  @param      *buff           è¦å‘é€çš„æ•°ç»„åœ°å€
  231          //  @param      len             å‘é€é•¿åº¦
  232          //  @return     void
  233          //  Sample usage:               uart_putbuff(UART_1,&a[0],5);
  234          //-------------------------------------------------------------------------------------------------------
             -------------
  235          void uart_putbuff(UARTN_enum uart_n,uint8 *p,uint16 len)
  236          {
  237   1          while(len--)
  238   1              uart_putchar(uart_n,*p++);
  239   1      }
  240          
  241          
  242          //-------------------------------------------------------------------------------------------------------
             -------------
  243          //  @brief      ä¸²å£å‘é€å­—ç¬¦ä¸²
C251 COMPILER V5.60.0,  zf_uart                                                            14/03/22  14:44:39  PAGE 5   

  244          //  @param      uart_n          ä¸²å£æ¨¡å—å·(USART_1,USART_2,USART_3,USART_4)
  245          //  @param      *str            è¦å‘é€çš„å­—ç¬¦ä¸²åœ°å€
  246          //  @return     void
  247          //  Sample usage:               uart_putstr(UART_1,"i lvoe you"); 
  248          //-------------------------------------------------------------------------------------------------------
             -------------
  249          void uart_putstr(UARTN_enum uart_n,uint8 *str)
  250          {
  251   1          while(*str)
  252   1          {
  253   2              uart_putchar(uart_n, *str++);
  254   2          }
  255   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       606     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =       205         12
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =    ------     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
