C251 COMPILER V5.60.0,  SEEKFREE_BLUETOOTH_CH9141                                          14/03/22  14:44:40  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE SEEKFREE_BLUETOOTH_CH9141
OBJECT MODULE PLACED IN .\Output\SEEKFREE_BLUETOOTH_CH9141.obj
COMPILER INVOKED BY: C:\Keil_v5\C251\BIN\C251.EXE Lib\seekfree_peripheral\SEEKFREE_BLUETOOTH_CH9141.c XSMALL INTR2 WARNI
                    -NGLEVEL(3) BROWSE INCDIR(.\Code;.\Lib\libraries;.\Lib\seekfree_libraries;.\Lib\seekfree_peripheral;.\User) DEFINE(USE_87
                    -01E) DEBUG PRINT(.\Output\SEEKFREE_BLUETOOTH_CH9141.lst) OBJECT(.\Output\SEEKFREE_BLUETOOTH_CH9141.obj) 

stmt  level    source

    1          /********************************************************************************************************
             -*************
    2           * COPYRIGHT NOTICE
    3           * Copyright (c) 2021,é€é£ç§‘æŠ€
    4           * All rights reserved.
    5           * æŠ€æœ¯è®¨è®ºQQç¾¤ï¼šä¸€ç¾¤ï¼š179029047(å·²æ»¡)  äºŒç¾¤ï¼š244861897
    6           *
    7           * ä»¥ä¸‹æ‰€æœ‰å†…å®¹ç‰ˆæƒå‡å±é€é£ç§‘æŠ€æ‰€æœ‰ï¼Œæœªç»å…è®¸ä¸å¾—ç”¨äºå•†ä¸šç”¨é€”ï¼Œ
    8           * æ¬¢è¿å„ä½ä½¿ç”¨å¹¶ä¼ æ’­æœ¬ç¨‹åºï¼Œä¿®æ”¹å†…å®¹æ—¶å¿…é¡»ä¿ç•™é€é£ç§‘æŠ€çš„ç‰ˆæƒå£°æ˜ã€‚
    9           *
   10           * @file                é€é£ç§‘æŠ€è“ç‰™è½¬ä¸²å£æ¨¡å—
   11           * @company                     æˆéƒ½é€é£ç§‘æŠ€æœ‰é™å…¬å¸
   12           * @author              é€é£ç§‘æŠ€(QQ3184284598)
   13           * @version             æŸ¥çœ‹docå†…versionæ–‡ä»¶ ç‰ˆæœ¬è¯´æ˜
   14           * @Software            IAR 8.3 or MDK 5.33
   15           * @Taobao              https://seekfree.taobao.com/
   16           * @date                2021-08-27
   17           * @note                
   18                                                  æ¥çº¿å®šä¹‰ï¼š
   19                                                  ------------------------------------ 
   20                                                      è“ç‰™è½¬ä¸²å£      å•ç‰‡æœº                        
   21                                                  RX              æŸ¥çœ‹SEEKFREE_BLUETOOTH_CH9141.hæ–‡ä»¶ä¸­çš„BLUETOOTH_CH9141_UART_TXå®å®šä¹‰
   22                                                  TX              æŸ¥çœ‹SEEKFREE_BLUETOOTH_CH9141.hæ–‡ä»¶ä¸­çš„BLUETOOTH_CH9141_UART_RXå®å®šä¹‰
   23                                                  RTS             æŸ¥çœ‹SEEKFREE_BLUETOOTH_CH9141.hæ–‡ä»¶ä¸­çš„BLUETOOTH_CH9141_RTS_PINå®å®šä¹‰
   24                                  CTS             æ‚¬ç©º
   25                                                  CMD             æ‚¬ç©ºæˆ–è€…ä¸Šæ‹‰
   26                                                  ------------------------------------ 
   27           ********************************************************************************************************
             -************/
   28          #include "stdio.h"
   29          #include "string.h"
   30          #include "board.h"
   31          #include "zf_gpio.h"
   32          #include "zf_uart.h"
   33          #include "zf_nvic.h"
   34          #include "zf_delay.h"
   35          
   36          
   37          #include "SEEKFREE_BLUETOOTH_CH9141.h"
   38          
   39          
   40          uint8 uart_data;
   41          uint8 uart_flag;
   42          
   43          vuint8 at_mode = 0;         //0:è“ç‰™é€ä¼ æ¨¡å¼ 1:ATæ¨¡å¼ 2:æ¨¡å—å¤ä½ä¸­
   44          vuint8 at_mode_num;         //atæ¨¡å¼æ—¶ç”¨äºæŒ‡ç¤ºæ•°æ®æ¥æ”¶çš„æ•°é‡
   45          vuint8 at_mode_data[30];    //æ¥æ”¶atå‘½ä»¤çš„ç¼“å­˜
   46          vuint8 at_mode_cmd_flag;    //OKåº”ç­”å‘½ä»¤æ¥æ”¶æˆåŠŸçš„æ ‡å¿—ä½
   47          
   48          uint8 mac_address[17];      //æœ¬æœºmacåœ°å€
   49          
   50          
   51          uint8 bluetooth_ch9141_rx_buffer;
   52          
   53          
   54          void bluetooth_ch9141_check_response(void);
   55          
C251 COMPILER V5.60.0,  SEEKFREE_BLUETOOTH_CH9141                                          14/03/22  14:44:40  PAGE 2   

   56          //-------------------------------------------------------------------------------------------------------
             -------------
   57          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å— ä¸²å£ä¸­æ–­å›è°ƒå‡½æ•°
   58          //  @param      NULL
   59          //  @return     void                                    
   60          //  @since      v1.0
   61          //  Sample usage:       
   62          //  @note       è¯¥å‡½æ•°åœ¨ISRæ–‡ä»¶ ä¸²å£8ä¸­æ–­ç¨‹åºè¢«è°ƒç”¨
   63          //-------------------------------------------------------------------------------------------------------
             -------------
   64          void bluetooth_ch9141_uart_callback(void)
   65          {
   66   1          if(1 == at_mode)
   67   1          {
   68   2              //è¿›å…¥ATæ¨¡å¼ æ¥æ”¶åº”ç­”ä¿¡å· æ­¤å¤„ifè¯­å¥å†…ä»£ç ç”¨æˆ·ä¸è¦æ”¹åŠ¨
   69   2              //æ­¤å¤„ifè¯­å¥å†…ä»£ç ç”¨æˆ·ä¸è¦æ”¹åŠ¨
   70   2              at_mode_data[at_mode_num++] = BLUETOOTH_CH9141_DATA_BUF;
   71   2              bluetooth_ch9141_check_response();
   72   2          }
   73   1          else if(2 == at_mode)
   74   1          {
   75   2              //æ¨¡å—æ­£åœ¨å¤ä½ä¸­ æ­¤å¤„ifè¯­å¥å†…ä»£ç ç”¨æˆ·ä¸è¦æ”¹åŠ¨
   76   2              //æ­¤å¤„ifè¯­å¥å†…ä»£ç ç”¨æˆ·ä¸è¦æ”¹åŠ¨
   77   2              at_mode_num++;
   78   2          }
   79   1          else
   80   1          {
   81   2              //é€ä¼ æ¨¡å¼ ç”¨æˆ·åœ¨æ­¤å¤„æ¥æ”¶é…å¯¹çš„è“ç‰™å‘é€è¿‡æ¥çš„é¢æ•°æ®
   82   2              //æ¥åˆ°ä¸€ä¸ªå­—èŠ‚åå•ç‰‡æœºå°†ä¼šè¿›å…¥æ­¤å¤„ï¼Œé€šè¿‡åœ¨æ­¤å¤„è¯»å–bluetooth_ch9141_rx_buf
             -ferå¯ä»¥å–èµ°æ•°æ®
   83   2              uart_data = BLUETOOTH_CH9141_DATA_BUF;
   84   2          }
   85   1              
   86   1      
   87   1      }
   88          
   89          //-------------------------------------------------------------------------------------------------------
             -------------
   90          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—æ£€æŸ¥OKåº”ç­”ä¿¡å·
   91          //  @param      NULL
   92          //  @return     void                                    
   93          //  @since      v1.0
   94          //  Sample usage:       
   95          //  @note       ç”¨æˆ·æ— éœ€å…³å¿ƒ
   96          //-------------------------------------------------------------------------------------------------------
             -------------
   97          void bluetooth_ch9141_check_response(void)
   98          {
   99   1          if(4 <= at_mode_num)
  100   1          {
  101   2              if(0 == strncmp("OK\r\n", (int8 *)&at_mode_data[at_mode_num-4], 4))
  102   2              {
  103   3                  at_mode_cmd_flag = 1;
  104   3              }
  105   2          }
  106   1      }
  107          
  108          //-------------------------------------------------------------------------------------------------------
             -------------
  109          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—å‘é€ä¸€ä¸ªæ²¡æœ‰å‚æ•°çš„å‘½ä»¤å¹¶ç­‰å¾…åº”ç­”ä¿¡å·
  110          //  @param      *str    éœ€è¦å‘é€çš„å‘½ä»¤ å®Œæ•´å­—ç¬¦ä¸²
  111          //  @return     void                                    
  112          //  @since      v1.0
  113          //  Sample usage:       
  114          //  @note       ç”¨æˆ·æ— éœ€å…³å¿ƒ
  115          //-------------------------------------------------------------------------------------------------------
C251 COMPILER V5.60.0,  SEEKFREE_BLUETOOTH_CH9141                                          14/03/22  14:44:40  PAGE 3   

             -------------
  116          void bluetooth_ch9141_send_at_command(const int8 *str)
  117          {
  118   1          at_mode_num = 0;        //æ¥æ”¶æ•°é‡æ¸…é›¶
  119   1          uart_putstr(BLUETOOTH_CH9141_UART, str);
  120   1          uart_putstr(BLUETOOTH_CH9141_UART, "\r\n");
  121   1          
  122   1          //ç­‰å¾…æ”¶åˆ°åº”ç­”ä¿¡å·
  123   1          while(!at_mode_cmd_flag);
  124   1          at_mode_cmd_flag = 0;
  125   1      }
  126          
  127          //-------------------------------------------------------------------------------------------------------
             -------------
  128          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—å‘é€ä¸€ä¸ªå¸¦æœ‰å‚æ•°çš„å‘½ä»¤å¹¶ç­‰å¾…åº”ç­”ä¿¡å·
  129          //  @param      *cmd    éœ€è¦å‘é€çš„å‘½ä»¤åç§°
  130          //  @param      *dat   éœ€è¦å‘é€çš„æ•°æ®
  131          //  @return     void                                    
  132          //  @since      v1.0
  133          //  Sample usage:       
  134          //  @note       ç”¨æˆ·æ— éœ€å…³å¿ƒ
  135          //-------------------------------------------------------------------------------------------------------
             -------------
  136          void bluetooth_ch9141_send_at_command_parameter(const int8 *cmd, const int8 *dat)
  137          {
  138   1          at_mode_num = 0;        //æ¥æ”¶æ•°é‡æ¸…é›¶
  139   1          uart_putstr(BLUETOOTH_CH9141_UART, "AT+");
  140   1          uart_putstr(BLUETOOTH_CH9141_UART, cmd);
  141   1          uart_putstr(BLUETOOTH_CH9141_UART, "=");
  142   1          uart_putstr(BLUETOOTH_CH9141_UART, dat);
  143   1          uart_putstr(BLUETOOTH_CH9141_UART, "\r\n");
  144   1          
  145   1          //ç­‰å¾…æ”¶åˆ°åº”ç­”ä¿¡å·
  146   1          while(!at_mode_cmd_flag);
  147   1          at_mode_cmd_flag = 0;
  148   1      }
  149          
  150          //-------------------------------------------------------------------------------------------------------
             -------------
  151          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—è¿›å…¥ATæ¨¡å¼
  152          //  @param      NULL
  153          //  @return     void                                    
  154          //  @since      v1.0
  155          //  Sample usage:       
  156          //  @note       
  157          //-------------------------------------------------------------------------------------------------------
             -------------
  158          void bluetooth_ch9141_enter_at_mode(void)
  159          {
  160   1          delay_ms(600);  //å‘é€è¿›å…¥ATæ¨¡å¼çš„å‘½ä»¤å‰éœ€è¦ä¿è¯æ¨¡å—åœ¨550mså†…æ²¡æœ‰æ¥æ”¶è¿‡ä»»ä½•æ
             -•°æ®
  161   1          at_mode = 1;            //è¿›å…¥ATæ¨¡å¼
  162   1          bluetooth_ch9141_send_at_command("AT...");
  163   1      }
  164          
  165          //-------------------------------------------------------------------------------------------------------
             -------------
  166          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—é€€å‡ºATæ¨¡å¼
  167          //  @param      NULL
  168          //  @return     void                                    
  169          //  @since      v1.0
  170          //  Sample usage:       
  171          //  @note       
  172          //-------------------------------------------------------------------------------------------------------
             -------------
  173          void bluetooth_ch9141_exit_at_mode(void)
C251 COMPILER V5.60.0,  SEEKFREE_BLUETOOTH_CH9141                                          14/03/22  14:44:40  PAGE 4   

  174          {
  175   1          bluetooth_ch9141_send_at_command("AT+EXIT");
  176   1          at_mode = 0;            //è¿›å…¥é€ä¼ æ¨¡å¼
  177   1          delay_ms(300);  //ç­‰å¾…æˆåŠŸè¿›å…¥ATæ¨¡å¼
  178   1      }
  179          
  180          //-------------------------------------------------------------------------------------------------------
             -------------
  181          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—å¤ä½
  182          //  @param      NULL
  183          //  @return     void                                    
  184          //  @since      v1.0
  185          //  Sample usage:       
  186          //  @note       
  187          //-------------------------------------------------------------------------------------------------------
             -------------
  188          void bluetooth_ch9141_reset(void)
  189          {
  190   1          bluetooth_ch9141_send_at_command("AT+RESET");
  191   1          at_mode = 2;            //è¿›å…¥é‡å¯æˆåŠŸæ£€æµ‹
  192   1          at_mode_num = 0;
  193   1          while(7 > at_mode_num); //ç­‰å¾…è“ç‰™æ¨¡å—å®Œæˆå¤ä½
  194   1          at_mode = 0;            //å¤ä½ä¹‹åæ¨¡å—è‡ªåŠ¨è¿›å…¥é€ä¼ æ¨¡å¼
  195   1      }
  196          
  197          //-------------------------------------------------------------------------------------------------------
             -------------
  198          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—è·å–æœ¬æœºMACåœ°å€
  199          //  @param      NULL
  200          //  @return     void                                    
  201          //  @since      v1.0
  202          //  Sample usage:       
  203          //  @note       è°ƒç”¨æ­¤å‡½æ•°éœ€è¦å…ˆè°ƒç”¨bluetooth_ch9141_enter_at_modeæˆ–è€…æ‹‰ä½CMDå¼•è„š è¿›å…¥A
             -Tæ¨¡å¼
  204          //              éœ€è¦ç‰¹åˆ«æ³¨æ„bluetooth_ch9141_enter_at_modeå‡½æ•°å†…éƒ¨æœ‰500msçš„å»¶æ—¶
  205          //-------------------------------------------------------------------------------------------------------
             -------------
  206          void bluetooth_ch9141_get_mac_address(void)
  207          {
  208   1          bluetooth_ch9141_send_at_command("AT+MAC?");
  209   1          
  210   1          //macåœ°å€ä¸ºå°æ®µæ ¼å¼ï¼Œmac_address[0]ä¿å­˜çš„æ˜¯macåœ°å€æœ€ä½ä½
  211   1          memcpy(mac_address, (uint8 *)at_mode_data, 17);
  212   1      }
  213          
  214          //-------------------------------------------------------------------------------------------------------
             -------------
  215          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—è®¾ç½®å‘é€åŠŸç‡
  216          //  @param      tx_power    è®¾ç½®å‘é€åŠŸç‡ï¼Œå¯è®¾ç½®é€‰é¡¹æŸ¥çœ‹CH9141_TX_POWEER_enumæšä¸¾æˆå‘˜
  217          //  @return     void                                    
  218          //  @since      v1.0
  219          //  Sample usage:       
  220          //  @note       
  221          //-------------------------------------------------------------------------------------------------------
             -------------
  222          void bluetooth_ch9141_set_tx_power(CH9141_TX_POWEER_enum tx_power)
  223          {
  224   1          int8 tx_power_data;
  225   1          
  226   1          tx_power_data = (uint8)tx_power + '0';
  227   1          bluetooth_ch9141_send_at_command_parameter("TPL", &tx_power_data);
  228   1      }
  229          
  230          //-------------------------------------------------------------------------------------------------------
             -------------
  231          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—è®¾ç½®æ¨¡å¼
C251 COMPILER V5.60.0,  SEEKFREE_BLUETOOTH_CH9141                                          14/03/22  14:44:40  PAGE 5   

  232          //  @param      mode    æ¨¡å¼è®¾ç½®ï¼Œå¯è®¾ç½®é€‰é¡¹æŸ¥çœ‹CH9141_MODE_enumæšä¸¾æˆå‘˜
  233          //  @return     void                                    
  234          //  @since      v1.0
  235          //  Sample usage:       
  236          //  @note       
  237          //-------------------------------------------------------------------------------------------------------
             -------------
  238          void bluetooth_ch9141_set_mode(CH9141_MODE_enum mode)
  239          {
  240   1          int8 mode_data;
  241   1          
  242   1          mode_data = (uint8)mode + '0';
  243   1          bluetooth_ch9141_send_at_command_parameter("BLEMODE", &mode_data);
  244   1      }
  245          
  246          //-------------------------------------------------------------------------------------------------------
             -------------
  247          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—è·å–çŠ¶æ€
  248          //  @param      mode    æ¨¡å¼è®¾ç½®ï¼Œå¯è®¾ç½®é€‰é¡¹æŸ¥çœ‹CH9141_MODE_enumæšä¸¾æˆå‘˜
  249          //  @return     CH9141_STATUS_enum  è¿”å›çŠ¶æ€ä¿¡æ¯
  250          //  @since      v1.0
  251          //  Sample usage:       
  252          //  @note       
  253          //-------------------------------------------------------------------------------------------------------
             -------------
  254          CH9141_STATUS_enum bluetooth_ch9141_get_status(CH9141_MODE_enum mode)
  255          {
  256   1          CH9141_STATUS_enum ch9141_status;
  257   1          int8 mode_data;
  258   1          
  259   1          mode_data = (uint8)mode + '0';
  260   1          bluetooth_ch9141_send_at_command_parameter("BLEMODE", &mode_data);
  261   1          
  262   1          bluetooth_ch9141_send_at_command("AT+BLESTA?");
  263   1          
  264   1          ch9141_status = (at_mode_data[0] - '0') * 10 + (at_mode_data[1] - '0');
  265   1          if(SLAVE_MODE == mode)
  266   1          {
  267   2              ch9141_status += SLAVE_NO_INIT;
  268   2          }
  269   1          
  270   1          return ch9141_status;
  271   1      }
  272          
  273          //-------------------------------------------------------------------------------------------------------
             -------------
  274          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—è®¾ç½®è®¾å¤‡åç§°
  275          //  @param      *str    è“ç‰™åç§°
  276          //  @return     void                                    
  277          //  @since      v1.0
  278          //  Sample usage:       
  279          //  @note       åç§°é•¿åº¦ä¸èƒ½è¶…è¿‡18ä¸ªå­—ç¬¦ ä¸”åªèƒ½ä¸ºè‹±æ–‡ä¸æ•°å­—
  280          //-------------------------------------------------------------------------------------------------------
             -------------
  281          void bluetooth_ch9141_set_name(const int8 *str)
  282          {
  283   1          bluetooth_ch9141_send_at_command_parameter("NAME", str);
  284   1          bluetooth_ch9141_send_at_command_parameter("PNAME", str);
  285   1      }
  286          
  287          //-------------------------------------------------------------------------------------------------------
             -------------
  288          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—å¯†ç è®¾ç½®
  289          //  @param      enable      ä½¿èƒ½å¯†ç  0ï¼šä¸ä½¿ç”¨å¯†ç ï¼Œ1ï¼šä½¿ç”¨å¯†ç æ‰èƒ½è¿æ¥æœ¬è®¾å¤‡
  290          //  @param      *password   å¯†ç çš„å­—ç¬¦ä¸² å¿…é¡»ä¸º6ä¸ªå­—ç¬¦
  291          //  @return     void                                    
C251 COMPILER V5.60.0,  SEEKFREE_BLUETOOTH_CH9141                                          14/03/22  14:44:40  PAGE 6   

  292          //  @since      v1.0
  293          //  Sample usage:       
  294          //  @note       
  295          //-------------------------------------------------------------------------------------------------------
             -------------
  296          void bluetooth_ch9141_set_password(uint8 enable, const int8 *password)
  297          {
  298   1          if(0 == enable)
  299   1          {
  300   2              //å…³é—­å¯†ç 
  301   2              bluetooth_ch9141_send_at_command_parameter("PASEN", "OFF");
  302   2          }
  303   1          else
  304   1          {
  305   2              //è®¾ç½®å¯†ç å¹¶ä½¿èƒ½
  306   2              bluetooth_ch9141_send_at_command_parameter("PASEN", "ON");
  307   2              bluetooth_ch9141_send_at_command_parameter("PASS", password);
  308   2          }
  309   1      }
  310          
  311          //-------------------------------------------------------------------------------------------------------
             -------------
  312          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—æŒ‡å®šMACåœ°å€å¹¶ç«‹å³è¿›è¡Œè¿æ¥
  313          //  @param      *mac_and_password      éœ€è¦è¿æ¥çš„è®¾å¤‡macåœ°å€ä¸å¯†ç 
  314          //  @return     void                                    
  315          //  @since      v1.0
  316          //  Sample usage:       
  317          //  @note       bluetooth_ch9141_connect("58:B7:33:E4:C2:84,000000");
  318          //              58:B7:33:E4:C2:84ä¸ºmacåœ°å€ ,ä¸ºåˆ†éš”ç¬¦ 000000ä¸ºä»æœºè“ç‰™å¯†ç 
  319          //              ===================ç‰¹åˆ«æ³¨æ„==================
  320          //              å¦‚æœä½¿ç”¨æ‰‹æœºæŸ¥çœ‹è“ç‰™çš„macåœ°å€ï¼Œåˆ™ä½¿ç”¨æœ¬å‡½æ•°è¿æ¥çš„æ—¶å€™è¯·å°†macå€
             -’ç½®ä¸€ä¸‹
  321          //              ä¾‹å¦‚æ‰‹æœºæŸ¥çœ‹åˆ°çš„macåœ°å€ä¸º61:62:63:64:65:66ï¼Œåˆ™ä½¿ç”¨æœ¬å‡½æ•°è¿æ¥çš„æ—¶å€™
             -åº”è¯¥å†™
  322          //              bluetooth_ch9141_connect("66:65:64:63:62:61,000000");
  323          //-------------------------------------------------------------------------------------------------------
             -------------
  324          void bluetooth_ch9141_connect(const int8 *mac_and_password)
  325          {
  326   1          bluetooth_ch9141_send_at_command_parameter("CONN", mac_and_password);
  327   1      }
  328          
  329          //-------------------------------------------------------------------------------------------------------
             -------------
  330          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—é»˜è®¤è¿æ¥å‚æ•°è®¾ç½®ï¼ˆè®¾ç½®å¥½åï¼Œæ¯æ¬¡å¼€æœºè“ç‰™ä¼šè‡ªåŠ
             -¨é“¾æ¥è¿™ä¸ªè®¾å¤‡ï¼‰
  331          //  @param      *mac_and_password      éœ€è¦è¿æ¥çš„è®¾å¤‡macåœ°å€ä¸å¯†ç 
  332          //  @return     void                                    
  333          //  @since      v1.0
  334          //  Sample usage:       
  335          //  @note       bluetooth_ch9141_default_connect("58:B7:33:E4:C2:84,000000");
  336          //              58:B7:33:E4:C2:84ä¸ºmacåœ°å€ ,ä¸ºåˆ†éš”ç¬¦ 000000ä¸ºä»æœºè“ç‰™å¯†ç 
  337          //              ===================ç‰¹åˆ«æ³¨æ„==================
  338          //              å¦‚æœä½¿ç”¨æ‰‹æœºæŸ¥çœ‹CH9141çš„macåœ°å€ï¼Œå°†CH9141è®¾ç½®ä¸ºä»æœºï¼Œä½¿ç”¨æ‰‹æœºè¿æ
             -¥
  339          //              åˆ™ä½¿ç”¨æœ¬å‡½æ•°è¿æ¥çš„æ—¶å€™è¯·å°†macå€’ç½®ä¸€ä¸‹
  340          //              ä¾‹å¦‚æ‰‹æœºæŸ¥çœ‹åˆ°çš„macåœ°å€ä¸º61:62:63:64:65:67ï¼Œåˆ™ä½¿ç”¨æœ¬å‡½æ•°è¿æ¥çš„æ—¶å€™
             -åº”è¯¥å†™
  341          //              bluetooth_ch9141_default_connect("67:65:64:63:62:61,000000");
  342          //-------------------------------------------------------------------------------------------------------
             -------------
  343          void bluetooth_ch9141_default_connect(const int8 *mac_and_password)
  344          {
  345   1          bluetooth_ch9141_send_at_command_parameter("CONADD", mac_and_password);
  346   1      }
  347          
C251 COMPILER V5.60.0,  SEEKFREE_BLUETOOTH_CH9141                                          14/03/22  14:44:40  PAGE 7   

  348          //-------------------------------------------------------------------------------------------------------
             -------------
  349          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—è·å–rssi(ä¿¡å·å¼ºåº¦)
  350          //  @param      void      
  351          //  @return     int8    è¿”å›ä¿¡å·å¼ºåº¦0åˆ°-127
  352          //  @since      v1.0
  353          //  Sample usage:       
  354          //  @note       è°ƒç”¨æ­¤å‡½æ•°éœ€è¦å…ˆè°ƒç”¨bluetooth_ch9141_enter_at_modeæˆ–è€…æ‹‰ä½CMDå¼•è„š è¿›å…¥A
             -Tæ¨¡å¼
  355          //              éœ€è¦ç‰¹åˆ«æ³¨æ„bluetooth_ch9141_enter_at_modeå‡½æ•°å†…éƒ¨æœ‰500msçš„å»¶æ—¶
  356          //-------------------------------------------------------------------------------------------------------
             -------------
  357          int16 bluetooth_ch9141_get_rssi(void)
  358          {
  359   1          uint8 i;
  360   1          size_t length;
  361   1          int16 rssi;
  362   1          bluetooth_ch9141_send_at_command_parameter("RSSI", "ON,0");
  363   1          length = strlen((int8 *)at_mode_data);
  364   1          length -= 12;//è®¡ç®—RSSI æœ‰å¤šå°‘ä½
  365   1          
  366   1          rssi = 0;
  367   1          for(i=0; i<length; i++)
  368   1          {
  369   2              rssi = rssi*10 + (at_mode_data[0] - '0');
  370   2          }
  371   1          
  372   1          return -rssi;
  373   1      }
  374          
  375          //-------------------------------------------------------------------------------------------------------
             -------------
  376          //  @brief      æ— çº¿è½¬ä¸²å£æ¨¡å— å‘é€å‡½æ•°
  377          //  @param      buff        éœ€è¦å‘é€çš„æ•°æ®åœ°å€
  378          //  @param      len         å‘é€é•¿åº¦
  379          //  @return     uint32      å‰©ä½™æœªå‘é€çš„å­—èŠ‚æ•°   
  380          //  @since      v1.0
  381          //  Sample usage:       
  382          //  @note       
  383          //-------------------------------------------------------------------------------------------------------
             -------------
  384          uint32 bluetooth_ch9141_send_buff(uint8 *buff, uint32 len)
  385          {
  386   1          while(len)
  387   1          {
  388   2              //æµæ§æ£€æŸ¥ RTSä¸ºé«˜è¡¨ç¤ºè“ç‰™æ¨¡å—å†…éƒ¨ç¼“å†²å·²æ»¡æ— æ³•ç»§ç»­æ¥æ”¶æ•°æ®
  389   2              
  390   2              //RTSä¸ºé«˜å¤„ç†æ–¹å¼ä¸€ï¼šå¦‚æœæ£€æµ‹åˆ°RTSä¸ºé«˜åˆ™åé¢çš„æ•°æ®ä¸å†ç»§ç»­å‘é€ï¼Œé¿å…
             -å‡ºç°ç­‰å¾…
  391   2              if(BLUETOOTH_CH9141_RTS_PIN)  
  392   2              {
  393   3                  break;
  394   3              }
  395   2              
  396   2              //RTSä¸ºé«˜å¤„ç†æ–¹å¼äºŒï¼šå¦‚æœæ£€æµ‹åˆ°RTSä¸ºé«˜åˆ™ç­‰å¾…RTSä¸ºä½ä¹‹åç»§ç»­å‘é€æ•°æ®
  397   2              //while(gpio_get(BLUETOOTH_CH9141_RTS_PIN));  //å¦‚æœRTSä¸ºä½ç”µå¹³ï¼Œåˆ™ç»§ç»­å‘é€æ•°æ®
  398   2              
  399   2              //å‘é€æ•°æ®
  400   2              uart_putchar(BLUETOOTH_CH9141_UART, *buff);
  401   2      
  402   2              buff++;
  403   2              len--; 
  404   2          }
  405   1      
  406   1          return len;
  407   1      }
C251 COMPILER V5.60.0,  SEEKFREE_BLUETOOTH_CH9141                                          14/03/22  14:44:40  PAGE 8   

  408          
  409          
  410          
  411          
  412          
  413          //-------------------------------------------------------------------------------------------------------
             -------------
  414          //  @brief      è“ç‰™è½¬ä¸²å£æ¨¡å—åˆå§‹åŒ–
  415          //  @param      mode    è“ç‰™æ¨¡å¼ MASTER_MODE(ä¸»æœº)æˆ–è€…SLAVE_MODE(ä»æœº)
  416          //  @return     void                                    
  417          //  @since      v1.0
  418          //  Sample usage:       
  419          //  @note       
  420          //-------------------------------------------------------------------------------------------------------
             -------------
  421          void bluetooth_ch9141_init(CH9141_MODE_enum mode, int8 *salve_mac_password)
  422          {
  423   1      
  424   1          //===================ç‰¹åˆ«æ³¨æ„==================
  425   1          //å¦‚æœä½¿ç”¨æ‰‹æœºæŸ¥çœ‹è“ç‰™çš„macåœ°å€ï¼Œåˆ™ä½¿ç”¨æœ¬å‡½æ•°è¿æ¥çš„æ—¶å€™è¯·å°†macå€’ç½®ä¸€ä¸‹
  426   1          //ä¾‹å¦‚æ‰‹æœºæŸ¥çœ‹åˆ°çš„macåœ°å€ä¸º61:62:63:64:65:66ï¼Œåˆ™ä½¿ç”¨æœ¬å‡½æ•°è¿æ¥çš„æ—¶å€™åº”è¯¥å†™
  427   1          //bluetooth_ch9141_connect("66:65:64:63:62:61,000000");
  428   1          //58:B7:33:E4:C2:84ä¸ºmacåœ°å€ ,ä¸ºåˆ†éš”ç¬¦ 000000ä¸ºä»æœºè“ç‰™å¯†ç 
  429   1          //ä»æœºMACåœ°å€ä¸å¯†ç 
  430   1      
  431   1      
  432   1          //æœ¬å‡½æ•°ä½¿ç”¨çš„æ³¢ç‰¹ç‡ä¸º115200ï¼Œä¸ºè“ç‰™è½¬ä¸²å£æ¨¡å—çš„é»˜è®¤æ³¢ç‰¹ç‡ï¼Œå¦‚éœ€å…¶ä»–æ³¢
             -ç‰¹ç‡è¯·ä½¿ç”¨ä¸Šä½æœºä¿®æ”¹æ¨¡å—å‚æ•°
  433   1          //åˆå§‹åŒ–æµæ§å¼•è„š
  434   1          wireless_type = WIRELESS_CH9141;
  435   1          //å¦‚æœä¸æ¥RTSå¼•è„šï¼Œåˆ™RTSå¼•è„šé»˜è®¤ä¸ºé«˜ç”µå¹³ï¼Œè¿™é‡Œéœ€è¦å°†å…¶è®¾ç½®ä¸ºä½ç”µå¹³ã€‚
  436   1          BLUETOOTH_CH9141_RTS_PIN = 0;
  437   1          //åˆå§‹åŒ–ä¸²å£
  438   1          uart_init (BLUETOOTH_CH9141_UART, BLUETOOTH_CH9141_UART_RX, BLUETOOTH_CH9141_UART_TX, BLUETOOTH_CH914
             -1_UART_BAUD, BLUETOOTH_CH9141_TIMER_N);        //åˆå§‹æ¢ä¸²å£    
  439   1      
  440   1          EnableGlobalIRQ();
  441   1          
  442   1          //è“ç‰™åˆ†ä¸ºä¸»æœºä¸ä»æœºæ¨¡å¼ï¼Œä¸¤ä¸ªè“ç‰™æƒ³è¦è¿æ¥æˆåŠŸå°±å¿…é¡»æœ‰ä¸€ä¸ªä¸ºä¸»æœºï¼Œæœ‰
             -ä¸€ä¸ªä¸ºä»æœºï¼Œæ‰€ä»¥è°ƒç”¨åˆå§‹åŒ–çš„æ—¶å€™éœ€è¦åˆç†çš„å¡«å†™å‡½æ•°å‚æ•°æ‰èƒ½æˆåŠŸçš„è¿æ¥
  443   1          //è“ç‰™åˆ†ä¸ºä¸»æœºä¸ä»æœºæ¨¡å¼ï¼Œä¸¤ä¸ªè“ç‰™æƒ³è¦è¿æ¥æˆåŠŸå°±å¿…é¡»æœ‰ä¸€ä¸ªä¸ºä¸»æœºï¼Œæœ‰
             -ä¸€ä¸ªä¸ºä»æœºï¼Œæ‰€ä»¥è°ƒç”¨åˆå§‹åŒ–çš„æ—¶å€™éœ€è¦åˆç†çš„å¡«å†™å‡½æ•°å‚æ•°æ‰èƒ½æˆåŠŸçš„è¿æ¥
  444   1          //ä¸Šç”µé¡ºåºï¼šæœ€å¥½ä»æœºå…ˆä¸Šç”µï¼Œç„¶åä¸»æœºå†ä¸Šç”µ
  445   1      
  446   1          if(MASTER_MODE == mode)
  447   1          {
  448   2              //1.å°†è“ç‰™è®¾ç½®ä¸ºä¸»æœºæ¨¡å¼ï¼Œç„¶åè¿æ¥æŒ‡å®šmacåœ°å€çš„ä»æœºè®¾å¤‡
  449   2      
  450   2              bluetooth_ch9141_enter_at_mode();  //è¿›å…¥ATæ¨¡å¼
  451   2              bluetooth_ch9141_set_mode(mode);   //è®¾ç½®è“ç‰™æ¨¡å¼
  452   2              bluetooth_ch9141_get_mac_address();//è·å–æœ¬æœºMACåœ°å€
  453   2                      bluetooth_ch9141_reset();                  //è®¾ç½®å®Œæˆåéœ€è¦å¤ä½ï¼Œè®¾ç½®æ‰ä¼šç”Ÿæ•ˆ
  454   2                      bluetooth_ch9141_enter_at_mode();          //è¿›å…¥ATæ¨¡å¼
  455   2      
  456   2                      //è®¾ç½®å®Œæ¨¡å¼ä¹‹åéœ€è¦å¤ä½ç„¶åå†æ¬¡è¿›å…¥ATæ¨¡å¼æ‰èƒ½ç»§ç»­è®¾ç½®å…¶ä»–å‚æ•°ï¼Œå¦åˆ™æ¨¡
             -å¼è®¾ç½®ä¸æˆåŠŸ
  457   2              bluetooth_ch9141_set_tx_power(TX_POWER_4DB);//è®¾ç½®è“ç‰™å‘é€åŠŸç‡
  458   2      
  459   2              
  460   2              bluetooth_ch9141_default_connect(salve_mac_password);  //é…ç½®é»˜è®¤è¿æ¥å‚æ•°ï¼Œå³ä½¿ä¸‹æ¬¡ä
             -¸é…ç½®ä¹Ÿä¼šè‡ªåŠ¨è¿æ¥ä»æœº
  461   2              bluetooth_ch9141_connect(salve_mac_password);          //ç«‹å³è¿æ¥è®¾ç½®çš„ä»æœºåœ°å€
  462   2      
  463   2              //ç­‰å¾…è¿æ¥æˆåŠŸ
  464   2              while(MASTER_CONNECTED != bluetooth_ch9141_get_status(mode));
  465   2              bluetooth_ch9141_exit_at_mode();                       //é€€å‡ºATæ¨¡å¼
C251 COMPILER V5.60.0,  SEEKFREE_BLUETOOTH_CH9141                                          14/03/22  14:44:40  PAGE 9   

  466   2          }
  467   1          else if(SLAVE_MODE == mode)
  468   1          {
  469   2              //2.è“ç‰™è®¾ç½®ä¸ºä»æœºå¹¶ç­‰å¾…è¿æ¥
  470   2              bluetooth_ch9141_enter_at_mode();  //è¿›å…¥ATæ¨¡å¼
  471   2              bluetooth_ch9141_set_mode(mode);   //è®¾ç½®è“ç‰™æ¨¡å¼
  472   2              bluetooth_ch9141_get_mac_address();//è·å–æœ¬æœºMACåœ°å€
  473   2                      bluetooth_ch9141_reset();                  //è®¾ç½®å®Œæˆåéœ€è¦å¤ä½ï¼Œè®¾ç½®æ‰ä¼šç”Ÿæ•ˆ
  474   2                      bluetooth_ch9141_enter_at_mode();          //è¿›å…¥ATæ¨¡å¼
  475   2      
  476   2                      //è®¾ç½®å®Œæ¨¡å¼ä¹‹åéœ€è¦å¤ä½ç„¶åå†æ¬¡è¿›å…¥ATæ¨¡å¼æ‰èƒ½ç»§ç»­è®¾ç½®å…¶ä»–å‚æ•°ï¼Œå¦åˆ™æ¨¡
             -å¼è®¾ç½®ä¸æˆåŠŸ
  477   2              bluetooth_ch9141_set_tx_power(TX_POWER_4DB);//è®¾ç½®è“ç‰™å‘é€åŠŸç‡
  478   2              bluetooth_ch9141_set_name("ble");
  479   2              bluetooth_ch9141_set_password(1, "000000");  //000000ä¸ºè“ç‰™å¯†ç å¯ä»¥è‡ªå·±ä¿®æ”¹
  480   2              bluetooth_ch9141_reset();                  //è®¾ç½®å®Œæˆåéœ€è¦å¤ä½ï¼Œè®¾ç½®æ‰ä¼šç”Ÿæ•ˆ
  481   2              bluetooth_ch9141_enter_at_mode();          //è¿›å…¥ATæ¨¡å¼
  482   2              //ç­‰å¾…è¿æ¥æˆåŠŸ
  483   2              while(SLAVE_CONNECTED != bluetooth_ch9141_get_status(mode));
  484   2              bluetooth_ch9141_exit_at_mode();           //é€€å‡ºATæ¨¡å¼
  485   2          }
  486   1          
  487   1          //å¦‚æœæƒ³è·å–æ— çº¿ä¿¡å·å¼ºåº¦å¯ä»¥æŒ‰ç…§ä¸‹é¢çš„ç¤ºä¾‹è°ƒç”¨
  488   1          //bluetooth_ch9141_enter_at_mode();
  489   1          //int16 rssi = bluetooth_ch9141_get_rssi();
  490   1          
  491   1          DisableGlobalIRQ();
  492   1      }
  493          
  494          
  495          
  496          
  497          


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       910     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =        53         15
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =       135     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
