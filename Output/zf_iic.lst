C251 COMPILER V5.60.0,  zf_iic                                                             14/03/22  14:44:38  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE zf_iic
OBJECT MODULE PLACED IN .\Output\zf_iic.obj
COMPILER INVOKED BY: C:\Keil_v5\C251\BIN\C251.EXE Lib\seekfree_libraries\zf_iic.c XSMALL INTR2 WARNINGLEVEL(3) BROWSE IN
                    -CDIR(.\Code;.\Lib\libraries;.\Lib\seekfree_libraries;.\Lib\seekfree_peripheral;.\User) DEFINE(USE_8701E) DEBUG PRINT(.\O
                    -utput\zf_iic.lst) OBJECT(.\Output\zf_iic.obj) 

stmt  level    source

    1          /********************************************************************************************************
             -*************
    2           * COPYRIGHT NOTICE
    3           * Copyright (c) 2020,é€é£ç§‘æŠ€
    4           * All rights reserved.
    5           * æŠ€æœ¯è®¨è®ºQQç¾¤ï¼šä¸€ç¾¤ï¼š179029047(å·²æ»¡)  äºŒç¾¤ï¼š244861897(å·²æ»¡)  ä¸‰ç¾¤ï¼š824575535
    6           *
    7           * ä»¥ä¸‹æ‰€æœ‰å†…å®¹ç‰ˆæƒå‡å±é€é£ç§‘æŠ€æ‰€æœ‰ï¼Œæœªç»å…è®¸ä¸å¾—ç”¨äºå•†ä¸šç”¨é€”ï¼Œ
    8           * æ¬¢è¿å„ä½ä½¿ç”¨å¹¶ä¼ æ’­æœ¬ç¨‹åºï¼Œä¿®æ”¹å†…å®¹æ—¶å¿…é¡»ä¿ç•™é€é£ç§‘æŠ€çš„ç‰ˆæƒå£°æ˜ã€‚
    9           *
   10           * @file                iic
   11           * @company                     æˆéƒ½é€é£ç§‘æŠ€æœ‰é™å…¬å¸
   12           * @author              é€é£ç§‘æŠ€(QQ790875685)
   13           * @version             æŸ¥çœ‹docå†…versionæ–‡ä»¶ ç‰ˆæœ¬è¯´æ˜
   14           * @Software            MDK FOR C251 V5.60
   15           * @Target core         STC16F2K64S4
   16           * @Taobao              https://seekfree.taobao.com/
   17           * @date                2020-4-14
   18           ********************************************************************************************************
             -************/
   19          #pragma warning disable = 47
   20          #include "zf_iic.h"
   21          
   22          
   23          
   24          //-------------------------------------------------------------------------------------------------------
             -------------
   25          //  @brief      å†…éƒ¨ä½¿ç”¨ç”¨æˆ·æ— éœ€å…³å¿ƒ
   26          //  @param      NULL                    
   27          //  @return     void
   28          //  Sample usage:               æ— éœ€ç”¨æˆ·è°ƒç”¨ï¼Œç”¨æˆ·è¯·ä½¿ç”¨hæ–‡ä»¶ä¸­çš„å®å®šä¹‰
   29          //-------------------------------------------------------------------------------------------------------
             -------------
   30          void iic_delay_us(uint16 x)     //33.1776Mhz
   31          {
   32   1          uint8 i;
   33   1          while(x--)
   34   1          {
   35   2                      i = 9;
   36   2                      while (--i);
   37   2          }
   38   1      }
   39          
   40          
   41          //-------------------------------------------------------------------------------------------------------
             -------------
   42          //  @brief      å†…éƒ¨ä½¿ç”¨ç”¨æˆ·æ— éœ€å…³å¿ƒ
   43          //  @param      NULL                    
   44          //  @return     void
   45          //  Sample usage:               æ— éœ€ç”¨æˆ·è°ƒç”¨ï¼Œç”¨æˆ·è¯·ä½¿ç”¨hæ–‡ä»¶ä¸­çš„å®å®šä¹‰
   46          //-------------------------------------------------------------------------------------------------------
             -------------
   47          uint8 wait(void)
   48          {
   49   1          uint16 count = 0;
   50   1          uint8 ret = IIC_SEND_OK;
   51   1          while (!(I2CMSST & 0x40))
C251 COMPILER V5.60.0,  zf_iic                                                             14/03/22  14:44:38  PAGE 2   

   52   1          {
   53   2              iic_delay_us(1);
   54   2              if(count++ >= 30)//ç­‰å¾…è¶…è¿‡30usï¼Œåˆ™é€€å‡ºç­‰å¾…ã€‚
   55   2              {
   56   3                  ret = IIC_SEND_FAIL;
   57   3                  break;
   58   3              }
   59   2          }
   60   1          I2CMSST &= ~0x40;
   61   1          return ret;
   62   1      }
   63          
   64          //-------------------------------------------------------------------------------------------------------
             -------------
   65          //  @brief      å†…éƒ¨ä½¿ç”¨ç”¨æˆ·æ— éœ€å…³å¿ƒ
   66          //  @param      NULL                    
   67          //  @return     void
   68          //  Sample usage:               æ— éœ€ç”¨æˆ·è°ƒç”¨ï¼Œç”¨æˆ·è¯·ä½¿ç”¨hæ–‡ä»¶ä¸­çš„å®å®šä¹‰
   69          //-------------------------------------------------------------------------------------------------------
             -------------
   70          uint8 start(void)
   71          {
   72   1          uint8 ret;
   73   1          I2CMSCR = 0x01;                             //å‘é€startå‘½ä»¤
   74   1          ret = wait();
   75   1          return ret;
   76   1      }
   77          
   78          //-------------------------------------------------------------------------------------------------------
             -------------
   79          //  @brief      å†…éƒ¨ä½¿ç”¨ç”¨æˆ·æ— éœ€å…³å¿ƒ
   80          //  @param      NULL                    
   81          //  @return     void
   82          //  Sample usage:               æ— éœ€ç”¨æˆ·è°ƒç”¨ï¼Œç”¨æˆ·è¯·ä½¿ç”¨hæ–‡ä»¶ä¸­çš„å®å®šä¹‰
   83          //-------------------------------------------------------------------------------------------------------
             -------------
   84          uint8 send_data(char dat)
   85          {
   86   1          uint8 ret;
   87   1          I2CTXD = dat;                               //å†™æ•°æ®åˆ°æ•°æ®ç¼“å†²åŒº
   88   1          I2CMSCR = 0x02;                             //å‘é€SENDå‘½ä»¤
   89   1          ret = wait();
   90   1          return ret;
   91   1      }
   92          
   93          //-------------------------------------------------------------------------------------------------------
             -------------
   94          //  @brief      å†…éƒ¨ä½¿ç”¨ç”¨æˆ·æ— éœ€å…³å¿ƒ
   95          //  @param      NULL                    
   96          //  @return     void
   97          //  Sample usage:               æ— éœ€ç”¨æˆ·è°ƒç”¨ï¼Œç”¨æˆ·è¯·ä½¿ç”¨hæ–‡ä»¶ä¸­çš„å®å®šä¹‰
   98          //-------------------------------------------------------------------------------------------------------
             -------------
   99          uint8 recv_ack(void)
  100          {
  101   1          uint8 ret;
  102   1          I2CMSCR = 0x03;                             //å‘é€è¯»ACKå‘½ä»¤
  103   1          ret = wait();
  104   1          return ret;
  105   1      }
  106          
  107          //-------------------------------------------------------------------------------------------------------
             -------------
  108          //  @brief      å†…éƒ¨ä½¿ç”¨ç”¨æˆ·æ— éœ€å…³å¿ƒ
  109          //  @param      NULL                    
  110          //  @return     void
C251 COMPILER V5.60.0,  zf_iic                                                             14/03/22  14:44:38  PAGE 3   

  111          //  Sample usage:               æ— éœ€ç”¨æˆ·è°ƒç”¨ï¼Œç”¨æˆ·è¯·ä½¿ç”¨hæ–‡ä»¶ä¸­çš„å®å®šä¹‰
  112          //-------------------------------------------------------------------------------------------------------
             -------------
  113          char recv_data(void)                                                    //æ¥æ”¶æ•°æ®
  114          {
  115   1          I2CMSCR = 0x04;                             //å‘é€RECVå‘½ä»¤
  116   1          wait();
  117   1          return I2CRXD;
  118   1      }
  119          
  120          //-------------------------------------------------------------------------------------------------------
             -------------
  121          //  @brief      å†…éƒ¨ä½¿ç”¨ç”¨æˆ·æ— éœ€å…³å¿ƒ
  122          //  @param      NULL                    
  123          //  @return     void
  124          //  Sample usage:               æ— éœ€ç”¨æˆ·è°ƒç”¨ï¼Œç”¨æˆ·è¯·ä½¿ç”¨hæ–‡ä»¶ä¸­çš„å®å®šä¹‰
  125          //-------------------------------------------------------------------------------------------------------
             -------------
  126          uint8 send_ack(void)
  127          {
  128   1              uint8 ret;
  129   1          I2CMSST = 0x00;                             //è®¾ç½®ACKä¿¡å·
  130   1          I2CMSCR = 0x05;                             //å‘é€ACKå‘½ä»¤
  131   1          ret = wait();
  132   1          return ret;
  133   1      }
  134          
  135          //-------------------------------------------------------------------------------------------------------
             -------------
  136          //  @brief      å†…éƒ¨ä½¿ç”¨ç”¨æˆ·æ— éœ€å…³å¿ƒ
  137          //  @param      NULL                    
  138          //  @return     void
  139          //  Sample usage:               æ— éœ€ç”¨æˆ·è°ƒç”¨ï¼Œç”¨æˆ·è¯·ä½¿ç”¨hæ–‡ä»¶ä¸­çš„å®å®šä¹‰
  140          //-------------------------------------------------------------------------------------------------------
             -------------
  141          void send_nak(void)
  142          {
  143   1          I2CMSST = 0x01;                             //è®¾ç½®NAKä¿¡å·
  144   1          I2CMSCR = 0x05;                             //å‘é€ACKå‘½ä»¤
  145   1          wait();
  146   1      }
  147          
  148          //-------------------------------------------------------------------------------------------------------
             -------------
  149          //  @brief      å†…éƒ¨ä½¿ç”¨ç”¨æˆ·æ— éœ€å…³å¿ƒ
  150          //  @param      NULL                    
  151          //  @return     void
  152          //  Sample usage:               æ— éœ€ç”¨æˆ·è°ƒç”¨ï¼Œç”¨æˆ·è¯·ä½¿ç”¨hæ–‡ä»¶ä¸­çš„å®å®šä¹‰
  153          //-------------------------------------------------------------------------------------------------------
             -------------
  154          uint8 stop(void)
  155          {
  156   1          uint8 ret;
  157   1          I2CMSCR = 0x06;                             //å‘é€stopå‘½ä»¤
  158   1          ret = wait();
  159   1          return ret;
  160   1      }
  161          
  162          
  163          
  164          
  165          //#define UNUSED(expr1, expr2) do { if(scl_pin == sda_pin); } while (0)
  166          //-------------------------------------------------------------------------------------------------------
             -------------
  167          //  @brief      ç¡¬ä»¶IICåˆå§‹åŒ–
  168          //  @param      iic_n           é€‰æ‹©IICæ¨¡å—
C251 COMPILER V5.60.0,  zf_iic                                                             14/03/22  14:44:38  PAGE 4   

  169          //  @param      wait_time       I2Cæ€»çº¿é€Ÿåº¦ï¼ˆç­‰å¾…æ—¶é’Ÿæ•°ï¼‰æ§åˆ¶: é€Ÿåº¦è®¾ç½®ä¸ºç­‰å¾…wait_tim
             -e*2+1ä¸ªæ—¶é’Ÿ
  170          //  @return     void
  171          //  Sample usage:              
  172          //-------------------------------------------------------------------------------------------------------
             -------------
  173          void iic_init(IICN_enum iic_n, IIC_PIN_enum scl_pin, IIC_PIN_enum sda_pin, uint32 wait_time)
  174          {
  175   1              //UNUSED(scl_pin);
  176   1              //__attribute__ ((unused))(sda_pin);
  177   1              //UNUSED(scl_pin, sda_pin);
  178   1      
  179   1          P_SW2 &= ~(0x03<<4);
  180   1          P_SW2 |= 1<<7;      //å°†EAXFRå¯„å­˜å™¨ç½®1ï¼Œè¿™æ ·æ‰èƒ½ä½¿ç”¨ç‰¹æ®ŠåŠŸèƒ½å¯„å­˜å™¨ä¸ºæ‰©å±•SFRï¼Œè®¿é—®
             -é€»è¾‘åœ°å€ä½äº XDATA åŒºåŸŸ
  181   1          switch(iic_n)
  182   1          {
  183   2          case IIC_1:
  184   2              P_SW2 |= (0x00<<4);     //SCL:P1.5      SDA:P1.4
  185   2              break;
  186   2          case IIC_2:
  187   2              P_SW2 |= (0x01<<4);     //SCL:P2.5      SDA:P2.4
  188   2              break;
  189   2          case IIC_3:
  190   2              P_SW2 |= (0x02<<4);     //SCL:P7.7      SDA:P7.6
  191   2              break;
  192   2          case IIC_4:
  193   2              P_SW2 |= (0x03<<4);     //SCL:P3.2      SDA:P3.3
  194   2              break;
  195   2          }
  196   1      
  197   1          I2CCFG |= 1<<6;             //ä¸»æœºæ¨¡å¼
  198   1          I2CCFG |= 1<<7;             //ä½¿èƒ½IIC
  199   1          I2CCFG |= wait_time;//é€Ÿåº¦è®¾ç½®ä¸ºç­‰å¾…wait_time*2+1ä¸ªæ—¶é’Ÿ
  200   1          I2CMSST = 0x00;             //ä¸»æœºçŠ¶æ€å¯„å­˜å™¨
  201   1      
  202   1      }
  203          
  204          //-------------------------------------------------------------------------------------------------------
             -------------
  205          //  @brief      å†™å…¥ä¸€ä¸ªå­—èŠ‚æ•°æ®åˆ°I2Cè®¾å¤‡æŒ‡å®šå¯„å­˜å™¨åœ°å€
  206          //  @param      iic_n       IICæ¨¡å—(IIC_1,IIC_2,IIC_3,IIC_0)
  207          //  @param      slaveid     ä»æœºåœ°å€(7ä½åœ°å€)
  208          //  @param      reg         ä»æœºå¯„å­˜å™¨åœ°å€
  209          //  @param      dat         éœ€è¦å‘é€çš„æ•°æ®
  210          //  @return                 è¿”å›çš„çŠ¶æ€å€¼ 0ï¼šæˆåŠŸ  1ï¼šå¤±è´¥
  211          //  @since      v2.0
  212          //  Sample usage:               iic_write_reg(0x2D, 0x50,2);     //å†™å…¥æ•°æ®2åˆ°0x50åœ°å€ï¼Œä»æœºåœ°å€ä¸º0
             -x2D
  213          //-------------------------------------------------------------------------------------------------------
             -------------
  214          uint8 iic_write_reg(uint8 dev_add, uint8 reg, uint8 dat)
  215          {
  216   1          if(start() != IIC_SEND_OK)
  217   1              return IIC_SEND_FAIL;
  218   1          if(send_data((dev_add<<1) | 0x00) != IIC_SEND_OK)
  219   1              return IIC_SEND_FAIL;
  220   1          if(recv_ack() != IIC_SEND_OK)
  221   1              return IIC_SEND_FAIL;
  222   1          if(send_data(reg) != IIC_SEND_OK)
  223   1              return IIC_SEND_FAIL;
  224   1          if(recv_ack() != IIC_SEND_OK)
  225   1              return IIC_SEND_FAIL;
  226   1          if(send_data(dat) != IIC_SEND_OK)
  227   1              return IIC_SEND_FAIL;
  228   1          if(recv_ack() != IIC_SEND_OK)
C251 COMPILER V5.60.0,  zf_iic                                                             14/03/22  14:44:38  PAGE 5   

  229   1              return IIC_SEND_FAIL;
  230   1          if(stop() != IIC_SEND_OK)
  231   1              return IIC_SEND_FAIL;
  232   1      
  233   1      
  234   1          return IIC_SEND_OK;
  235   1      }
  236          
  237          //-------------------------------------------------------------------------------------------------------
             -------------
  238          //  @brief      è¯»å–I2Cè®¾å¤‡æŒ‡å®šåœ°å€å¯„å­˜å™¨çš„æ•°æ®
  239          //  @param      iic_n        I2Cé€šé“å·åŠå¼•è„š
  240          //  @param      dev_add     ä»æœºåœ°å€(7ä½åœ°å€)
  241          //  @param      reg         ä»æœºå¯„å­˜å™¨åœ°å€
  242          //  @param      dat         æ•°æ®åœ°å€
  243          //  @return                 è¯»å–çš„å¯„å­˜å™¨å€¼
  244          //  @since      v1.0
  245          //  Sample usage:               uint8 value = iic_read_reg(i2c0, 0x2D, 0x50);//è¯»å–0x50åœ°å€çš„æ•°æ®ï¼Œä»æœ
             -ºåœ°å€ä¸º0x2D
  246          //-------------------------------------------------------------------------------------------------------
             -------------
  247          uint8 iic_read_reg(uint8 dev_add, uint8 reg, uint8 *dat)
  248          {
  249   1              if(start() != IIC_SEND_OK)
  250   1              return IIC_SEND_FAIL;
  251   1              
  252   1          if(send_data((dev_add<<1) | 0x00) != IIC_SEND_OK)
  253   1              return IIC_SEND_FAIL;
  254   1          if(recv_ack() != IIC_SEND_OK)
  255   1              return IIC_SEND_FAIL;
  256   1              
  257   1          if(send_data(reg) != IIC_SEND_OK)
  258   1              return IIC_SEND_FAIL;
  259   1          if(recv_ack() != IIC_SEND_OK)
  260   1              return IIC_SEND_FAIL;
  261   1              
  262   1              
  263   1      //   if(start() != IIC_SEND_OK)
  264   1      //        return IIC_SEND_FAIL;
  265   1         
  266   1          if(send_data((dev_add<<1) | 0x01) != IIC_SEND_OK)
  267   1              return IIC_SEND_FAIL;
  268   1              
  269   1          if(recv_ack() != IIC_SEND_OK)
  270   1              return IIC_SEND_FAIL;
  271   1              
  272   1      
  273   1          *dat = recv_data(); //è¯»å–æ•°æ®
  274   1      
  275   1              
  276   1          if(send_ack() != IIC_SEND_OK)
  277   1              return IIC_SEND_FAIL;
  278   1              
  279   1          if(stop() != IIC_SEND_OK)
  280   1              return IIC_SEND_FAIL;
  281   1              
  282   1          return IIC_SEND_OK;
  283   1      }
  284          
  285          //-------------------------------------------------------------------------------------------------------
             -------------
  286          //  @brief      è¯»å–I2Cè®¾å¤‡æŒ‡å®šåœ°å€å¯„å­˜å™¨çš„æ•°æ®
  287          //  @param      iic_n       I2Cé€šé“å·åŠå¼•è„š
  288          //  @param      dev_add     ä»æœºåœ°å€(7ä½åœ°å€)
  289          //  @param      reg         ä»æœºå¯„å­˜å™¨åœ°å€
  290          //  @param      dat         è¯»å–çš„æ•°æ®å­˜å‚¨çš„åœ°å€
C251 COMPILER V5.60.0,  zf_iic                                                             14/03/22  14:44:38  PAGE 6   

  291          //  @param      num         è¯»å–å­—èŠ‚æ•°
  292          //  @return     void
  293          //  @since      v1.0
  294          //  Sample usage:               uint8 value = i2c_read_reg(i2c0, 0x2D, 0x50, 10, buf);//è¯»å–0x50åœ°å€çš„æ•°æ
             -®ï¼Œä»æœºåœ°å€ä¸º0x2Då¼€å§‹çš„10ä¸ªå­—èŠ‚
  295          //-------------------------------------------------------------------------------------------------------
             -------------
  296          uint8 iic_read_reg_bytes(uint8 dev_add, uint8 reg
  297                                                          , uint8 *dat, uint8 num)
  298          {
  299   1      
  300   1              if(start() != IIC_SEND_OK)
  301   1              return IIC_SEND_FAIL;
  302   1              
  303   1          if(send_data((dev_add<<1) | 0x00) != IIC_SEND_OK)
  304   1              return IIC_SEND_FAIL;
  305   1          if(recv_ack() != IIC_SEND_OK)
  306   1              return IIC_SEND_FAIL;
  307   1              
  308   1          if(send_data(reg) != IIC_SEND_OK)
  309   1              return IIC_SEND_FAIL;
  310   1          if(recv_ack() != IIC_SEND_OK)
  311   1              return IIC_SEND_FAIL;
  312   1      
  313   1              if(send_data((dev_add<<1) | 0x01) != IIC_SEND_OK)
  314   1                      return IIC_SEND_FAIL;
  315   1              if(recv_ack() != IIC_SEND_OK)
  316   1                      return IIC_SEND_FAIL;
  317   1      
  318   1          while(--num)
  319   1          {
  320   2              *dat = recv_data(); //è¯»å–æ•°æ®
  321   2                      if(send_ack() != IIC_SEND_OK)
  322   2                      {
  323   3                              return IIC_SEND_FAIL;
  324   3                      }
  325   2              dat++;
  326   2          }
  327   1              
  328   1              *dat = recv_data();
  329   1              
  330   1              if(send_ack() != IIC_SEND_OK)
  331   1                      return IIC_SEND_FAIL;
  332   1              
  333   1              if(stop() != IIC_SEND_OK)
  334   1                      return IIC_SEND_FAIL;
  335   1              
  336   1              return IIC_SEND_OK;
  337   1      }
  338          
  339          
  340          //-------------------------------------------------------------------------------------------------------
             -------------
  341          //  @brief      ç¡¬ä»¶IICå¼•è„šåˆ‡æ¢å‡½æ•°
  342          //  @param      iic_n           I2Cé€šé“å·åŠå¼•è„š
  343          //  @param      scl_pin         é€‰æ‹©SCLå¼•è„š
  344          //  @param      sda_pin         é€‰æ‹©SDAå¼•è„š
  345          //  Sample usage:                               
  346          //-------------------------------------------------------------------------------------------------------
             -------------
  347          void iic_change_pin(IICN_enum iic_n,IIC_PIN_enum scl_pin,IIC_PIN_enum sda_pin)
  348          {
  349   1          P_SW2 |= 1<<7;      //å°†EAXFRå¯„å­˜å™¨ç½®1ï¼Œè¿™æ ·æ‰èƒ½ä½¿ç”¨ç‰¹æ®ŠåŠŸèƒ½å¯„å­˜å™¨ä¸ºæ‰©å±•SFRï¼Œè®¿é—®
             -é€»è¾‘åœ°å€ä½äº XDATA åŒºåŸŸ
  350   1              
  351   1              P_SW2 &= ~(0x03<<4);    //æ¸…é™¤å¼•è„šåˆ‡æ¢ä½
C251 COMPILER V5.60.0,  zf_iic                                                             14/03/22  14:44:38  PAGE 7   

  352   1          switch(iic_n)       
  353   1          {
  354   2          case IIC_1:
  355   2              P_SW2 |= (0x00<<4);     //SCL:P1.5      SDA:P1.4
  356   2              break;
  357   2          case IIC_2:
  358   2              P_SW2 |= (0x01<<4);     //SCL:P2.5      SDA:P2.4
  359   2              break;
  360   2          case IIC_3:
  361   2              P_SW2 |= (0x02<<4); //SCL:P7.7  SDA:P7.6 STC8H 48è„šæ ¸å¿ƒæ¿æ²¡æœ‰è¯¥ç»„å¼•è„šã€‚
  362   2              break;
  363   2          case IIC_4:
  364   2              P_SW2 |= (0x03<<4);     //SCL:P3.2      SDA:P3.3
  365   2              break;
  366   2          }
  367   1              
  368   1              P_SW2 &= ~(1<<7);
  369   1      
  370   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       748     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =    ------         11
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =    ------     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
